# 魔兽世界技能自动化软件 - 系统架构设计文档

## 1. 概述

本系统是一个为《魔兽世界》游戏设计的技能自动化释放工具，它结合了图像识别技术和键盘模拟技术，能够根据玩家配置的技能优先级策略，自动判断当前应该释放的技能，并模拟键盘按键进行释放。

系统支持多职业和多种策略配置，每种职业和专精可以有独立的策略文件，实现了高度的可扩展性和灵活性。

## 2. 系统架构

```
+---------------------+
|   图形用户界面      |
|   (GUI - Tkinter)   |
+----------+----------+
           |
+----------v----------+
|   配置管理器        |
|   (YAML)            |
+----------+----------+
           |
+----------v----------+
|   自动化引擎        |
|   (核心控制逻辑)    |
+----+--------+-------+
     |        |
     |        +-----------------+
     |                          |
+----v---+              +-------v--------+
| 图像识别 |              | 键盘模拟器     |
| (YOLO)   |              | (pynput)       |
+----+---+              +-------+--------+
     |                          |
     |                          |
     +-----------+--------------+
                 |
         +-------v-------+
         |  游戏客户端   |
         | (魔兽世界)    |
         +---------------+
```

## 3. 模块详细设计

### 3.1 配置管理器 (ConfigurationManager)

#### 3.1.1 职责
- 管理所有用户配置，包括YOLO模型路径、按键模拟器配置、当前策略文件路径、模式切换键等
- 提供配置的读取和写入接口
- 为其他模块提供配置信息

#### 3.1.2 数据结构
```yaml
# YOLO模型配置
yolo_model_path: "runs/detect/train/weights/best.pt"
screen_capture_region: null

# 按键模拟器配置
keystroke_sender:
  type: pynput
  keypress_delay_ms: 50

# 当前使用的策略文件
current_strategy: "strategies/frostfire_mage.yaml"

# 模式切换键配置
mode_switch_keys:
  aoe_mode: "f1"
  single_target_mode: "f2"
  stop_casting: "f3"
```

### 3.2 策略管理器 (StrategyManager)

#### 3.2.1 职责
- 管理多个策略配置文件
- 提供策略的加载、保存和切换功能
- 为自动化引擎提供当前策略信息

#### 3.2.2 策略文件结构
```yaml
name: "Frostfire Mage"
class: "Mage"
spec: "Frostfire"
description: "霜火法师输出循环策略"
global_cooldown: 1.5  # 每个职业可以有不同的全局冷却时间

# 按键绑定配置
bindings:
  frostbolt: "1"
  frozen_orb: "2"
  # ...更多按键绑定

# AOE模式优先级
aoe_priority:
  - name: "cone_of_cold"
    key: "cone_of_cold"
  # ...更多技能

# 单体模式优先级
single_target_priority:
  - name: "frostbolt"
    key: "frostbolt"
  # ...更多技能
```

### 3.3 图形用户界面 (GUI)

#### 3.3.1 职责
- 提供用户友好的界面进行策略配置
- 支持浏览和加载不同的策略文件
- 显示系统日志和状态信息
- 控制自动化引擎的启停

#### 3.3.2 功能特点
- 支持多标签页编辑不同模式的技能优先级
- 实时显示系统运行日志
- 提供策略文件的加载、保存和创建功能
- 可视化配置模式切换键

### 3.4 自动化引擎 (AutomationEngine)

#### 3.4.1 职责
- 核心控制逻辑，协调各模块工作
- 监听用户按键以切换模式
- 根据当前策略和技能状态决定释放哪个技能

#### 3.4.2 工作流程
1. 启动键盘监听器
2. 加载当前策略文件
3. 从策略文件中读取全局冷却时间配置
4. 等待用户切换模式（AOE/单体）
5. 根据当前模式获取对应的技能优先级列表
6. 使用YOLO检测技能冷却状态
7. 从优先级列表中找到第一个可用技能
8. 根据策略中的按键绑定获取实际按键
9. 模拟键盘按键释放技能
10. 等待全局冷却时间

### 3.5 图像识别引擎 (YoloDetector)

#### 3.5.1 职责
- 截取游戏画面
- 使用YOLO模型识别技能状态（冷却/可用）
- 返回检测结果给自动化引擎

#### 3.5.2 技术实现
- 使用PIL进行屏幕截图
- 利用Ultralytics YOLO进行图像识别
- 支持全屏或指定区域截图

### 3.6 键盘模拟器 (KeystrokeSender)

#### 3.6.1 职责
- 模拟真实的键盘按键
- 发送技能释放指令到游戏

#### 3.6.2 技术实现
- 基于pynput库实现键盘模拟
- 支持按键按下和释放的完整流程

## 4. 数据流设计

### 4.1 初始化流程
```
1. GUI启动
2. 加载主配置文件
3. 加载当前策略文件
4. 从策略文件中读取全局冷却时间
5. 初始化自动化引擎
6. 初始化YOLO模型
7. 初始化键盘模拟器
```

### 4.2 运行时流程
```
1. 用户按下模式键切换模式
2. 自动化引擎捕获模式切换事件
3. 定期截图游戏画面
4. YOLO模型识别技能状态
5. 自动化引擎根据当前策略和技能状态选择技能
6. 根据策略中的按键绑定获取实际按键
7. 键盘模拟器发送按键指令
```

## 5. 多策略支持设计

### 5.1 策略文件组织
策略文件统一存放在`strategies`目录下，每个职业/专精拥有独立的策略文件，便于管理和扩展。

### 5.2 策略切换机制
用户可以通过GUI选择不同的策略文件，系统会自动加载对应的策略配置。

### 5.3 策略扩展性
新增职业或专精只需创建新的策略文件，无需修改核心代码。

## 6. 使用说明

### 6.1 准备工作
1. 配置WeakAuras(WA)插件以显示技能冷却状态
2. 训练YOLO模型以识别技能状态
3. 创建或选择合适的策略文件

### 6.2 运行步骤
1. 启动GUI界面
2. 选择或创建策略文件
3. 配置技能优先级和按键绑定
4. 点击"启动引擎"按钮
5. 进入游戏并调整好WA位置
6. 按相应按键进入AOE或单体模式
7. 系统将根据配置自动释放技能
8. 按停止键停止技能释放

## 7. 扩展性设计

### 7.1 支持更多职业
通过在`strategies`目录中添加新的策略配置文件，可以轻松支持其他职业和专精。

### 7.2 替换图像识别引擎
当前使用YOLO，但可以通过实现统一接口来替换为其他图像识别方案。

### 7.3 替换键盘模拟器
目前使用pynput，但可以扩展支持其他硬件级键盘模拟器（如Kmbox）。

### 7.4 自定义模式切换键
用户可以在配置文件中自定义模式切换键，满足个性化需求。

### 7.5 职业特定配置
每个策略文件可以包含特定于该职业的配置，如全局冷却时间，使系统更加灵活。